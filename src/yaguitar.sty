%
% This file is under MPL 2.0 License
%
\ifx\makeatletter\undefined
  \def\makeatletter{\catcode`\@=11 }\relax
  \def\makeatother{\catcode`\@=12 }\relax
\fi
%
\makeatletter
%
\def\theChord#1{\strut{\bf #1}\hbox to 2pt{\hss}}%
%
\def\theGuitarEnvStart{%
\y@gParSave=\parindent
\y@gLeftSkip=\leftskip
\y@gRightSkip=\rightskip
\ifx\LaTeX\undefined
% plain
  \y@gDim=\parindent
  \advance \y@gDim by \leftskip
  \leftskip=\y@gDim
  \rightskip=\y@gDim plus 1fill
  \parindent=0pt
\else
% latex
  \leftskip=15pt
  \rightskip=15pt plus 1fill
  \parindent=0pt
\fi
\vskip \baselineskip
}%
%
\def\theGuitarEnvEnd{%
\vskip \baselineskip
\parindent=\y@gParSave
\leftskip=\y@gLeftSkip
\rightskip=\y@gRightSkip
}%
%
\def\chordSharp{\raise 4pt\hbox{$\sharp$}}%
\def\chordFlat{\raise 4pt\hbox{$\flat$}}%
%
\newdimen\chordskip \chordskip=\baselineskip
%
% macros for saving original definitions of active chars
%
\let\y@gSaveSharp\relax
\let\y@gSaveFlat\relax
\let\y@gSaveBracket\relax
\let\y@gSaveSpace\relax
\let\y@gSaveNewLine\relax
\let\y@gTempCmd\relax
%
%
%
\newbox\y@gChordBox
\newbox\y@gTempBox
\newbox\y@gTextBox
\newdimen\y@gDim
\newdimen\y@gParSave
\newskip\y@gLeftSkip
\newskip\y@gRightSkip
\let\y@gIfHaveSpace\iffalse
\let\y@gIfHaveTextBox\iffalse
%
% Active characters inside chord (# = sharp, b = flat)
%
\def\y@gActivateChordChars {\catcode`\#=13\catcode`b=13\relax}%
\def\y@gDeactivateChordChars {\catcode`\#=6\catcode`b=11\relax}%
%
\y@gActivateChordChars
%
\def\y@gChordCharsOn{%
\y@gActivateChordChars
\let\y@gSaveFlat b\let b\chordFlat
\let\y@gSaveSharp #\let #\chordSharp
}%
%
\def\y@gChordCharsOff{%
\let b\y@gSaveFlat
\let #\y@gSaveSharp
\y@gDeactivateChordChars
}%
%
\y@gDeactivateChordChars
%
\def\chord{\y@gChordCharsOn\y@gChord}%
%
\def\y@gChord#1{%
  \hskip 0pt
  \setbox \y@gChordBox = \hbox {\theChord{#1}}%
  \raise \chordskip \hbox to 0pt{\copy\y@gChordBox\hss}\y@gChordCharsOff
}%
%
%
%
\def\y@gChordEnv{%
  \y@gFlushTextBox
  \y@gChordCharsOn
  \y@gChordBracket
}%
%
\def\y@gChordBracket#1]{%
  \y@gChord{#1}%
  \let\y@gIfHaveSpace\iffalse
  \let\y@gIfHaveTextBox\iftrue
  \setbox\y@gTextBox=\hbox\bgroup
}%
%
\def\y@gFlushTextBox{%
  \y@gIfHaveTextBox
    \let\y@gTempCmd\egroup
  \else
    \let\y@gTempCmd\relax
  \fi
  \y@gTempCmd
  \y@gIfHaveTextBox
    \ifdim \wd\y@gTextBox>\wd\y@gChordBox
      \copy\y@gTextBox
    \fi
    \ifdim \wd\y@gTextBox=\wd\y@gChordBox
      \copy\y@gTextBox
    \fi
    \ifdim \wd\y@gTextBox<\wd\y@gChordBox
      \ifdim \wd\y@gTextBox=0pt
        \hbox to \wd\y@gChordBox{\copy\y@gTextBox\hss}%
      \else
        \y@gIfHaveSpace
          \hbox to \wd\y@gChordBox{\copy\y@gTextBox\hss}%
        \else
          \y@gDim=\wd\y@gChordBox
          \advance\y@gDim by -\wd\y@gTextBox
          \hbox to \wd\y@gChordBox{\copy\y@gTextBox\vrule width \y@gDim height 0.5ex depth -0.4ex}%
        \fi
      \fi
    \fi
  \fi
  \let\y@gIfHaveTextBox\iffalse
}%
%
%
\def\y@gActivateEnvChars{\catcode`\^^M=13\catcode`\[=13\catcode`\ =13}%
\def\y@gDeactivateEnvChars{\catcode`\^^M=5\catcode`\[=12\catcode`\ =10}%
%
\def\y@gNewLine{\y@gSpace\y@gFlushTextBox\par\leavevmode}%
\def\y@gSpace{%
  \space
  \y@gIfHaveTextBox
    \let\y@gTempCmd\egroup
  \else
    \let\y@gTempCmd\relax
  \fi
  \y@gTempCmd
  \let\y@gIfHaveSpace\iftrue
  \y@gIfHaveTextBox
    \let\y@gTempCmd\bgroup
  \else
    \let\y@gTempCmd\relax
  \fi
  \y@gTempCmd
  \y@gFlushTextBox}%
%\def\y@gSpace{\space\expandafter\y@gFlushTextBox\let\y@gIfHaveSpace\iftrue}%
%
%
%
\y@gActivateEnvChars%
%
\def\y@gOn{\y@gActivateEnvChars%
\let\y@gSaveBracket[\let[\y@gChordEnv%
\let\y@gSaveNewLine^^M\let^^M\y@gNewLine%
\let\y@gSaveSpace \let \y@gSpace%
}%
%
\def\y@gOff{%
\let[\y@gSaveBracket%
\let^^M\y@gSaveNewLine%
\let \y@gSaveSpace%
\y@gDeactivateEnvChars%
}%
%
\y@gDeactivateEnvChars%
%
%
%
\def\guitarOn{\y@gOn\theGuitarEnvStart\yagStropheNum=1}%
%
\def\guitarOff{\y@gOff\theGuitarEnvEnd}%
%
% Strophe numbering and refrain
%
\def\theRefrain{R. }%
%
\def\refrain{\hskip -4em\hbox to 4em{\hss\theRefrain}}%
%
\newcount\yagStropheNum
%
\def\theStrophe{\the\yagStropheNum{}. }%
%
\def\strophe{%
\hskip -4em\hbox to 4em{\hss\theStrophe}%
\global\advance\yagStropheNum by 1
}%
%
% latex support
%
\ifx\newenvironment\undefined\else
  \newenvironment{guitar}{\parindent=0pt\guitarOn}{\guitarOff}
\fi
%
\makeatother
\endinput
